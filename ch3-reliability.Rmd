---
title: 'Chapter 3: Reliability'
author: "BRT"
date: "8/10/2020"
output: 
  html_document:
    toc: yes
    toc_depth: 5
    toc_float: 
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(tidyverse)
library(fs)
theme_set(theme_minimal(base_size = 15) +
            theme(plot.title.position = "plot",
                  legend.position = "bottom"))
```

```{r load-data}
p <- here::here("data", "person-estimates") %>% 
  dir_ls() %>% 
  map_df(read_csv, .id = "f") %>% 
  mutate(f = gsub(here::here("data", "person-estimates"), "", f),
         grade = as.numeric(gsub("^/g(\\d\\d?).+", "\\1", f)),
         tier = as.numeric(gsub(".+\\dt(\\d).+", "\\1", f)),
         content = gsub(".+-(.+)\\..+", "\\1", f)) %>% 
  select(-f) 

i <- here::here("data", "item-estimates") %>% 
  dir_ls() %>% 
  map_df(read_csv, .id = "f") %>% 
  mutate(f = gsub(here::here("data", "item-estimates"), "", f),
         grade = as.numeric(gsub("^/g(\\d\\d?).+", "\\1", f)),
         tier = as.numeric(gsub(".+\\dt(\\d).+", "\\1", f)),
         content = gsub(".+-(.+)\\..+", "\\1", f)) %>% 
  select(-f)

items_by_test <- i %>% 
  group_by(grade, tier, content) %>% 
  nest()

persons_by_test <- p %>% 
  group_by(grade, tier, content) %>% 
  nest()
```
Marginal reliability is a measure of the overall reliability of a test, within an item response theory (IRT) framework, based on the average standard error conditioned on the range in person ability (or theta). The test information function (or TIF) conveys the precision of the test at any point in the person distribution, with the inverse representing the standard error in measurement. Thus, give this inverse relation, the larger the measurement error at a given theta value, the less information a test yields, typically, at the margins of the person distribution (e.g., extremely low or high scores on a test). The opposite is also true, the smaller the measurement error, the more information a test yields, typically, toward the center of the person distribution. Because measurement error varies across the range in theta based on the TIF, marginal reliability is calculated conditional on both theta and associated standard errors across the range in the calibrated scale. In this chapter, marginal reliability estimates are presented followed by plots of TIF by grade, content area, and tier for all tests comprising the PASA.

## Marginal Reliability by Content Area, Grade, and Tier

Marginal reliability estimates are generally within acceptable ranges for drawing test-based inferences, with ELA and Math more reliable, on average, than Science. Overall, marginal reliability values range from 0.59 to 0.86 across all content areas, grades, and tiers. For ELA, marginal reliability ranges from 0.78 to 0.86. For Math, marginal reliability ranges from 0.71 to 0.86. And for Science, marginal reliability ranges from 0.59 to 0.74, with the lowest reliability estimated for the Grade 8, Tier 1 (0.59) and Grade 11, Tier 1 (0.64) Science tests.

```{r marg-rel}
marg_rel <- function(theta, se) {
  s <- var(theta, na.rm = TRUE)
  e <- mean((se)^2, na.rm = TRUE)
  s/(s+e)
}
mr <- persons_by_test %>% 
  mutate(`Marginal Reliability` = map_dbl(data, ~marg_rel(.x$Theta, .x$SE))) %>% 
  select(-data) %>% 
  arrange(grade, tier, content)

names(mr)[1:3] <- stringr::str_to_title(names(mr)[1:3])
knitr::kable(mr, digits = 2)
```

## Test Information Functions by Content Area, Grade, and Tier

Below, TIFs are plotted by content area, grade and PASA test tier. The peak (or highest point) in the TIF is the point at which test information is maximized for a given theta (or person ability) estimate. Each plot shows the theta ranges for which marginal reliability is 0.80 (darker blue area under the TIF) and 0.70 (lighter blue area under the TIF). While many PASA tests provide precise information, with a marginal reliability of at least 0.80, on either side of average person ability (theta = 0; e.g., ELA, Grade 3, Tier 1, and Math, Grade 3, Tier 1), some PASA tests provide more precise information for lower person ability ranges (theta < 0), with less information provided at the higher end of the person ability distribution (e.g., ELA, Grade 3, Tier 2, and Math, Grade 3, Tier 2).

```{r tifs}
prob <- function(a, b, theta) {
  1 / (1 + exp(-1 * a * (theta - b)))
} 

information <- function(a, b, theta) {
  p <- prob(a, b, theta)
  q <- 1 - p
  a^2 * p * q
}

se_theta <- function(information) {
  1 / sqrt(information)
}

tif <- function(data, a_vec, b_vec, theta = seq(-5, 5, 0.01)) {
  info <- map2(data[[a_vec]], data[[b_vec]], ~information(.x, .y, theta)) %>% 
    pmap_dbl(sum)
  tibble(theta = theta,
         information = info,
         se = se_theta(information),
         rel = 1 - se^2,
         rel_range = ifelse(rel >= 0.8, "0.80", ifelse(
           rel >= 0.7 & rel < 0.8, "0.70", 
           NA_character_)
         )
  )
}

plot_information <- function(tif_df, grade, tier, content) {
  content <- ifelse(content == "ela", "ELA", stringr::str_to_title(content))
  
  ggplot(tif_df, aes(theta, information)) +
    geom_ribbon(aes(ymin = 0,
                    ymax = information,
                    fill = rel_range)) +
    geom_line() +
    scale_fill_manual(name = "Reliability Range",
                      breaks = c("0.70", "0.80"),
                      values = c("#b2cdf0", "#4f8dde")) +
    labs(x = "Theta",
         y = "Information",
         title = "Test Information Function",
         subtitle = glue::glue("{content}: Grade {grade}, Tier {tier}"))
}
  
items_by_test <- items_by_test %>% 
  mutate(tif = map(data, ~tif(.x, "a_estimate", "b_estimate")),
         plot = pmap(list(tif, grade, tier, content), plot_information)) %>% 
  arrange(grade, tier, content)

walk(items_by_test$plot, print)
```